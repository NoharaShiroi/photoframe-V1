<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ç›¸æ¡†ç…§ç‰‡æŒ‘é¸å™¨</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        button { padding: 12px 24px; font-size: 16px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin: 20px 0; padding: 10px; background: #e8f0fe; border-radius: 4px; white-space: pre-wrap; }
        #result { margin-top: 20px; padding: 10px; background: #e6f4ea; border-left: 4px solid #34a853; word-break: break-all; }
        .error { background: #fce8e8; border-left-color: #d93025; }
        a { color: #1a73e8; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ–¼ï¸ æŒ‘é¸ç›¸æ¡†ç…§ç‰‡</h1>
        <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æŒ‘é¸ç…§ç‰‡ã€‚å®Œæˆå¾Œæœƒè‡ªå‹•æ›´æ–°ä½ çš„æ•¸ä½ç›¸æ¡†ã€‚</p>
        <button id="startBtn" onclick="startPicker()">é–‹å§‹æŒ‘é¸ç…§ç‰‡</button>
        <div id="status"></div>
        <div id="result"></div>
    </div>

    <script>
        // è¨­å®šä½ çš„ Worker ç¶²å€ï¼ˆè«‹æ”¹æˆä½ è‡ªå·±çš„ï¼‰
        const WORKER_URL = 'https://photo-frame-worker.sheng8213.workers.dev';

        let sessionId = null;
        let pollInterval = 2000; // é è¨­ 2 ç§’ï¼Œå¯¦éš›ç”± API æ±ºå®š
        let checkTimer = null;

        function displayStatus(msg, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = msg;
            statusDiv.className = isError ? 'error' : '';
        }

        function displayResult(msg) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = msg;
        }

        async function startPicker() {
            document.getElementById('startBtn').disabled = true;
            displayStatus('æ­£åœ¨å»ºç«‹æŒ‘é¸å·¥ä½œéšæ®µ...');

            try {
                // 1. å‘¼å« Worker å»ºç«‹ session
                const resp = await fetch(`${WORKER_URL}/api/picker/create-session`, {
                    method: 'POST',
                });
                const data = await resp.json();

                if (!resp.ok) {
    // é¡¯ç¤ºå®Œæ•´çš„éŒ¯èª¤è©³æƒ…ï¼ˆå¦‚æœæœ‰ detail æ¬„ä½ï¼‰
    const errorMsg = data.detail ? `${data.error}: ${data.detail}` : (data.error || 'å»ºç«‹å¤±æ•—');
    throw new Error(errorMsg);
}

                sessionId = data.sessionId;
                pollInterval = data.pollInterval * 1000 || 2000; // è½‰æ›ç‚ºæ¯«ç§’

                displayStatus(`âœ… å·¥ä½œéšæ®µå·²å»ºç«‹ã€‚è«‹åœ¨æ–°åˆ†é ä¸­æŒ‘é¸ç…§ç‰‡ï¼Œç„¶å¾Œå›ä¾†ç­‰å€™ã€‚\n\né»æ“Šä¸‹æ–¹é€£çµé–‹å•Ÿ Google æŒ‘é¸å™¨ï¼š`);
                
                // é¡¯ç¤ºé€£çµ
                const linkDiv = document.createElement('div');
                linkDiv.innerHTML = `<a href="${data.pickerUri}" target="_blank">ğŸ‘‰ é»æ­¤é–‹å•ŸæŒ‘é¸å™¨ ğŸ‘ˆ</a>`;
                document.getElementById('status').appendChild(linkDiv);

                // 2. é–‹å§‹è¼ªè©¢æª¢æŸ¥ç‹€æ…‹
                startPolling();
            } catch (e) {
                displayStatus(`âŒ éŒ¯èª¤ï¼š${e.message}`, true);
                document.getElementById('startBtn').disabled = false;
            }
        }

        function startPolling() {
            if (!sessionId) return;
            displayStatus('ğŸ”„ ç­‰å¾…ä½ å®ŒæˆæŒ‘é¸... (æ¯ ' + (pollInterval/1000) + ' ç§’æª¢æŸ¥ä¸€æ¬¡)');
            checkTimer = setInterval(checkSession, pollInterval);
        }

        async function checkSession() {
            try {
                const resp = await fetch(`${WORKER_URL}/api/picker/check-session?sessionId=${sessionId}`);
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'æª¢æŸ¥å¤±æ•—');
                }

                if (data.mediaItemsSet) {
                    // é¸æ“‡å·²å®Œæˆï¼Œåœæ­¢è¼ªè©¢ï¼Œå–å¾—ç…§ç‰‡
                    clearInterval(checkTimer);
                    displayStatus('âœ… ç…§ç‰‡å·²é¸å–ï¼Œæ­£åœ¨å–å¾—åˆ—è¡¨...');
                    await getSelectedPhotos();
                } else {
                    // å°šæœªå®Œæˆï¼Œç¹¼çºŒç­‰å¾…
                    displayStatus('ğŸ”„ ç­‰å¾…ä½ å®ŒæˆæŒ‘é¸... (æ¯ ' + (pollInterval/1000) + ' ç§’æª¢æŸ¥ä¸€æ¬¡)');
                }
            } catch (e) {
                displayStatus(`âŒ æª¢æŸ¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${e.message}`, true);
                clearInterval(checkTimer);
                document.getElementById('startBtn').disabled = false;
            }
        }

        async function getSelectedPhotos() {
            try {
                const resp = await fetch(`${WORKER_URL}/api/picker/get-selected?sessionId=${sessionId}`);
                const data = await resp.json();

                if (!resp.ok) {
                    throw new Error(data.error || 'å–å¾—ç…§ç‰‡å¤±æ•—');
                }

                const count = data.photos.length;
                displayResult(`âœ… æˆåŠŸå–å¾— ${count} å¼µç…§ç‰‡ï¼ä½ çš„ç›¸æ¡†å·²è‡ªå‹•æ›´æ–°ã€‚\n\nç…§ç‰‡åˆ—è¡¨å·²å„²å­˜è‡³ KVï¼Œç¾åœ¨å¯ä»¥é—œé–‰æ­¤é é¢ã€‚`);
                displayStatus('ğŸ‰ å®Œæˆï¼');
                document.getElementById('startBtn').disabled = false;
            } catch (e) {
                displayStatus(`âŒ å–å¾—ç…§ç‰‡å¤±æ•—ï¼š${e.message}`, true);
                document.getElementById('startBtn').disabled = false;
            }
        }
    </script>
</body>
</html>
